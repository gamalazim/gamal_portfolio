<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    
    <title>Project IV: Is it possible to tell if a cow is in heat by monitoring her movement around the farm? | Gamal Abdel-Azim</title>
    <meta name="viewport" content="width=device-width,minimum-scale=1">
    <meta name="generator" content="Hugo 0.72.0" />
    
    
      <META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">
    

    
    
      <link href="https://gamalazim.github.io/gamal_portfolio/dist/css/app.4fc0b62e4b82c997bb0041217cd6b979.css" rel="stylesheet">
    

    

    
      

    

    
    
    <meta property="og:title" content="Project IV: Is it possible to tell if a cow is in heat by monitoring her movement around the farm?" />
<meta property="og:description" content="Associating patterns in sensory data with animals in heat" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://gamalazim.github.io/gamal_portfolio/post/project-4/" />
<meta property="article:published_time" content="2020-04-12T11:00:59-04:00" />
<meta property="article:modified_time" content="2020-04-12T11:00:59-04:00" />
<meta itemprop="name" content="Project IV: Is it possible to tell if a cow is in heat by monitoring her movement around the farm?">
<meta itemprop="description" content="Associating patterns in sensory data with animals in heat">
<meta itemprop="datePublished" content="2020-04-12T11:00:59-04:00" />
<meta itemprop="dateModified" content="2020-04-12T11:00:59-04:00" />
<meta itemprop="wordCount" content="1517">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Project IV: Is it possible to tell if a cow is in heat by monitoring her movement around the farm?"/>
<meta name="twitter:description" content="Associating patterns in sensory data with animals in heat"/>

	
  </head>

  <body class="ma0 avenir bg-near-white">

    
   
  

  
  
  <header class="cover bg-top" style="background-image: url('https://gamalazim.github.io/gamal_portfolio/images/heat_detect_proj.jpg');">
    <div class="pb3-m pb6-l bg-black-60">
      <nav class="pv3 ph3 ph4-ns" role="navigation">
  <div class="flex-l justify-between items-center center">
    <a href="https://gamalazim.github.io/gamal_portfolio/" class="f3 fw2 hover-white no-underline white-90 dib">
      
        Gamal Abdel-Azim
      
    </a>
    <div class="flex-l items-center">
      

      
        <ul class="pl0 mr3">
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="https://gamalazim.github.io/gamal_portfolio/about/" title="About page">
              About
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="https://gamalazim.github.io/gamal_portfolio/contact/" title="Contact page">
              Contact
            </a>
          </li>
          
          <li class="list f5 f4-ns fw4 dib pr3">
            <a class="hover-white no-underline white-90" href="https://gamalazim.github.io/gamal_portfolio/post/" title="Projects page">
              Projects
            </a>
          </li>
          
        </ul>
      
      




<a href="https://twitter.com/abdel_azim" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>




<a href="https://www.linkedin.com/in/gamal-abdel-azim-986a40122/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://github.com/gamalazim" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>








    </div>
  </div>
</nav>

      <div class="tc-l pv6 ph3 ph4-ns">
        
          <h1 class="f2 f1-l fw2 white-90 mb0 lh-title">Project IV: Is it possible to tell if a cow is in heat by monitoring her movement around the farm?</h1>
          
            <h2 class="fw1 f5 f3-l white-80 measure-wide-l center lh-copy mt3 mb4">
              Associating patterns in sensory data with animals in heat
            </h2>
          
        
      </div>
    </div>
  </header>



    <main class="pb7" role="main">
      
  
  <article class="flex-l flex-wrap justify-between mw8 center ph3">
    <header class="mt4 w-100">
      <aside class="instapaper_ignoref b helvetica tracked">
          
        PROJECTS
      </aside>
      




  <div id="sharing" class="mt3">

    
    <a href="https://www.facebook.com/sharer.php?u=https://gamalazim.github.io/gamal_portfolio/post/project-4/" class="facebook no-underline" aria-label="share on Facebook">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M28.765,50.32h6.744V33.998h4.499l0.596-5.624h-5.095  l0.007-2.816c0-1.466,0.14-2.253,2.244-2.253h2.812V17.68h-4.5c-5.405,0-7.307,2.729-7.307,7.317v3.377h-3.369v5.625h3.369V50.32z   M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;"/></svg>

    </a>

    
    
    <a href="https://twitter.com/share?url=https://gamalazim.github.io/gamal_portfolio/post/project-4/&amp;text=Project%20IV:%20Is%20it%20possible%20to%20tell%20if%20a%20cow%20is%20in%20heat%20by%20monitoring%20her%20movement%20around%20the%20farm?" class="twitter no-underline" aria-label="share on Twitter">
      <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

    </a>

    
    <a href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://gamalazim.github.io/gamal_portfolio/post/project-4/&amp;title=Project%20IV:%20Is%20it%20possible%20to%20tell%20if%20a%20cow%20is%20in%20heat%20by%20monitoring%20her%20movement%20around%20the%20farm?" class="linkedin no-underline" aria-label="share on LinkedIn">
      <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

    </a>
  </div>


      <h1 class="f1 athelas mt3 mb1">Project IV: Is it possible to tell if a cow is in heat by monitoring her movement around the farm?</h1>
      
      
      <time class="f6 mv4 dib tracked" datetime="2020-04-12T11:00:59-04:00">April 12, 2020</time>

      
      
    </header>
    <div class="nested-copy-line-height lh-copy serif f4 nested-links nested-img mid-gray pr4-l w-two-thirds-l"><h2 id="summary">Summary</h2>
<p>The objective here was to utilize daily sensory data to detect cows that are going through ovulation (in-heat). Automating the process of heat detection is important, particularly for large dairy farms. Alternative conventional methods for heat detection can be labor-intensive and more costly than the machine learning approach presented in this project. Sensors were put on animals for the purpose of recording the levels of physical and rumination activities. Only daily averages of these two types of activities were available for the purpose of heat detection. In this project, I will show how attributes were devised and engineered to improve F1 scores from 70 to near 90%. We will also be presenting performance measures useful with binary classification, as well as utilizing ROC curves for model selection.</p>
<h2 id="data">Data</h2>
<p>Only a couple of sensory values per animal per day were available as predictors. Therefore, the key here is to address feature creation and engineering. <em>The Database Component</em> behind this project was not trivial as data came in flat files from various systems (sensors, farm databases, and data processing centers), please refere to project I for an idea.</p>
<h2 id="feature-engineering-and-pattern-recognition">Feature engineering and pattern recognition</h2>
<h3 id="1-concatenate-data-of-a-whole-week">1. Concatenate data of a whole week</h3>
<p>Animals should show a particular pattern in their physical and rumination activities during the 3 to 5 days building toward ovulation. It is known for example that cows in-heat move around the farm a lot; they also experience changes in eating patterns. To capture these patterns across days, data of the past 7 days were used as predictors, in addition to data of the current day. This created 14 more predictors (7 for physical movement and 7 for rumination activity). It is helpful to look at this problem as a computer vision problem to capture the shape of a trend progressing across days preceding the condition addressed. In this case each day represents a pixel and daily activities represent pixel intensities.</p>
<h3 id="2-trend-variables">2. Trend variables</h3>
<p>The second set of attributes to add was a set of trend variables obtained by running a model through each of the past seven predictor days. The model estimated linear, quadratic, and cubic components, logs of their <em>p values</em>, and model <em>R-squared</em> for each instance in the data set. This required an efficient approach to run <em>2N</em> models, where <em>N</em> is the total rows in data with the model run twice, once for physical movement data, and a second for rumination data. The following R code was used:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-R" data-lang="R"><span style="color:#75715e"># Fast R function to run thousands of models in seconds!</span>
<span style="color:#75715e"># ------------------------------------------------------</span>
getTrendParms.3rdpwr.fast <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(X, y) {
  regr <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">.lm.fit</span>(X, y)  <span style="color:#75715e"># Run &#39;X: design matrix&#39; and &#39;y: labels&#39; thru fast &#39;.lm.fit&#39;</span>
  rss <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">sum</span>(regr<span style="color:#f92672">$</span>residuals^2)
  rdf <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">length</span>(y) <span style="color:#f92672">-</span> <span style="color:#a6e22e">ncol</span>(X)
  resvar <span style="color:#f92672">&lt;-</span> rss<span style="color:#f92672">/</span>rdf
  R <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">chol2inv</span>(regr<span style="color:#f92672">$</span>qr)  <span style="color:#75715e"># Inverse by Cholesky factorization</span>
  se <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">sqrt</span>(<span style="color:#a6e22e">diag</span>(R) <span style="color:#f92672">*</span> resvar)
  estBySe <span style="color:#f92672">&lt;-</span> regr<span style="color:#f92672">$</span>coef<span style="color:#f92672">/</span>se
  vary <span style="color:#f92672">=</span> <span style="color:#a6e22e">var</span>(y)
  <span style="color:#a6e22e">c</span>((<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> <span style="color:#a6e22e">var</span>(regr<span style="color:#f92672">$</span>residuals) <span style="color:#f92672">/</span> vary), estBySe, vary, <span style="color:#a6e22e">log</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#a6e22e">pt</span>(<span style="color:#a6e22e">abs</span>(estBySe),rdf,lower.tail<span style="color:#f92672">=</span><span style="color:#66d9ef">FALSE</span>)))
}

<span style="color:#75715e"># Run the function across data instances:</span>
<span style="color:#75715e"># ---------------------------------------</span>
x.design <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">cbind</span>(<span style="color:#ae81ff">1</span>, days, days^2, days^3)
scr.rtrendBlock <span style="color:#f92672">&lt;-</span> scr[,sdr.range]
scr.atrendBlock <span style="color:#f92672">&lt;-</span> scr[,sda.range]

<span style="color:#75715e"># Use apply to loop thru instances:</span>
<span style="color:#75715e"># ---------------------------------</span>
rBlock <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">t</span>(<span style="color:#a6e22e">apply</span>(scr.rtrendBlock, <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">function</span>(y) <span style="color:#a6e22e">getTrendParms.3rdpwr.fast</span>(x.design, y)))
aBlock <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">t</span>(<span style="color:#a6e22e">apply</span>(scr.atrendBlock, <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">function</span>(y) <span style="color:#a6e22e">getTrendParms.3rdpwr.fast</span>(x.design, y)))
</code></pre></div><h3 id="3-feature-structure">3. Feature structure</h3>
<p>Data included a week of past daily measures, trend variables estimated thru past days, season, and age of animal. Sensory data were structured as follows,
<img src="https://gamalazim.github.io/gamal_portfolio/images/data_chart_.png" alt="Chart of sensory data structure"></p>
<h3 id="4-labels">4. Labels</h3>
<p>Two classes of cases were used as labels: animals that were identified to be &lsquo;In-Heat&rsquo; and those that were actually &lsquo;BRED&rsquo;. Animals are &lsquo;BRED&rsquo; after becoming &lsquo;In-Heat&rsquo;. Labels were characterized as:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python">df[<span style="color:#e6db74">&#34;event_name&#34;</span>]<span style="color:#f92672">.</span>replace({<span style="color:#e6db74">&#39;BRED&#39;</span>:<span style="color:#e6db74">&#39;HEAT&#39;</span>}, inplace <span style="color:#f92672">=</span> True)
df[<span style="color:#e6db74">&#34;y&#34;</span>] <span style="color:#f92672">=</span> (df[<span style="color:#e6db74">&#34;event_name&#34;</span>] <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;HEAT&#39;</span>)
</code></pre></div><h2 id="data-sampling">Data sampling</h2>
<p>This is a situation where the positive cases were rare, about 2% of all cases. Stratified sampling across labels was important.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#75715e"># Stratified sampling of training and test sets --</span>
<span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> StratifiedShuffleSplit
split <span style="color:#f92672">=</span> StratifiedShuffleSplit(n_splits <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, test_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.2</span>, random_state <span style="color:#f92672">=</span> <span style="color:#ae81ff">7920</span>)
<span style="color:#66d9ef">for</span> train_index, test_index <span style="color:#f92672">in</span> split<span style="color:#f92672">.</span>split(df, df[<span style="color:#e6db74">&#34;y&#34;</span>]):
    train <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>loc[train_index]
    test <span style="color:#f92672">=</span> df<span style="color:#f92672">.</span>loc[test_index]

y_train, y_test <span style="color:#f92672">=</span> train[<span style="color:#e6db74">&#39;y&#39;</span>], test[<span style="color:#e6db74">&#39;y&#39;</span>]
train<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#39;event_name&#39;</span>, <span style="color:#e6db74">&#39;y&#39;</span>], axis <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, inplace <span style="color:#f92672">=</span> True)
test<span style="color:#f92672">.</span>drop([<span style="color:#e6db74">&#39;event_name&#39;</span>, <span style="color:#e6db74">&#39;y&#39;</span>], axis <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, inplace <span style="color:#f92672">=</span> True)

y_train<span style="color:#f92672">.</span>value_counts()<span style="color:#f92672">/</span>len(y_train)
<span style="color:#75715e"># False    0.977399</span>
<span style="color:#75715e"># True     0.022601</span>
y_test<span style="color:#f92672">.</span>value_counts()<span style="color:#f92672">/</span>len(y_test)
<span style="color:#75715e"># False    0.9774</span>
<span style="color:#75715e"># True     0.0226</span>
</code></pre></div><h2 id="binary-classification">Binary classification</h2>
<p>Data and classifier options to train:</p>
<ol>
<li>Stochastic gradient descent vs Random Forest</li>
<li>Test the value of using trend estimates as predictors</li>
<li>Adjust labels by moving the &lsquo;BRED&rsquo; category a day earlier to become aligned with animals in heat</li>
</ol>
<p>Let’s start by training a Stochastic Gradient Descent (SGD) classifier in Scikit-Learn’s SGDClassifier class. SGD is highly efficient in handling very large datasets, partly because it deals with training instances independently (which also makes SGD well suited for online learning). Let’s create an SGDClassifier and train it on the entire training set:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> sklearn.linear_model <span style="color:#f92672">import</span> SGDClassifier

train_prepared <span style="color:#f92672">=</span> full_pipeline<span style="color:#f92672">.</span>fit_transform(train)  <span style="color:#75715e"># pipeline to prepare numeric and categorical features, not shown</span>
sgd_clf <span style="color:#f92672">=</span> SGDClassifier(max_iter<span style="color:#f92672">=</span><span style="color:#ae81ff">1000</span>, tol<span style="color:#f92672">=</span><span style="color:#ae81ff">1e-3</span>, random_state<span style="color:#f92672">=</span><span style="color:#ae81ff">7920</span>)
sgd_clf<span style="color:#f92672">.</span>fit(train_prepared, y_train)
</code></pre></div><h2 id="performance-measures">Performance measures</h2>
<p>Evaluating classifiers is a little trickier than evaluating regressors, more measures than a RMSE or MAE will be needed here! Let&rsquo;s start with accuracy but note that we are predecting a rare case, occurring at 2% incidence, meaning that if we are wrong 100% of the time, our accuracy would still be 98%! So accuracy is not the answer here, but let&rsquo;s evaluate that as a start.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> cross_val_score
cross_val_score(sgd_clf, train_prepared, y_train, cv<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, scoring<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;accuracy&#34;</span>)
</code></pre></div><p>The table below shows 3 accuracy measures for SGD in the 3 cases studied here. There is indeed a slight improvement when trend variables were added and when labels were aligned. But accuracy is obviously not a good measure to rely on!</p>
<p><img src="https://gamalazim.github.io/gamal_portfolio/images/table_accuracies_.png" alt="Accuracy table"></p>
<p>Let&rsquo;s now get the actual predictions and construct a confusion matrix. This will help us look at better performance measures such as &lsquo;<em>Precision</em>&rsquo;, &lsquo;<em>Recall</em>&rsquo;, and &lsquo;<em>F1 Score</em>&rsquo;. In this problem, recall is of greater importance than precision as we are more interested in catching all animals that are in-heat even with some false positives.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#75715e"># cross_val_predict() to get the actual predictions and run them thru confusion_matrix</span>
<span style="color:#f92672">from</span> sklearn.model_selection <span style="color:#f92672">import</span> cross_val_predict
<span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> confusion_matrix
<span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> precision_score, recall_score, f1_score

y_train_pred <span style="color:#f92672">=</span> cross_val_predict(sgd_clf, train_prepared, y_train, cv<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>)
confusion_matrix(y_train, y_train_pred)
precision_score(y_train, y_train_pred)
recall_score(y_train, y_train_pred)
f1_score(y_train, y_train_pred)
</code></pre></div><p>The confusion matrices below show significant improvements in recall and F1 scores. It is clear that including trend variables and adjusting labels were important in improving our machine learning approaches.</p>
<p><img src="https://gamalazim.github.io/gamal_portfolio/images/table_thresh_0_.png" alt="Confusion Matrix table thresh = 0"></p>
<h2 id="selecting-a-good-precisionrecall-trade-off">Selecting a good precision/recall trade-off</h2>
<p>In this section, I will use a negative threshold to improve recall rates at the expense of a slight drop in precision. As explained earlier, recall was more important to this project than precision.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#75715e"># Use a non-zero thresh to increase recall</span>
y_scores <span style="color:#f92672">=</span> cross_val_predict(sgd_clf, train_prepared, y_train, cv<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, method<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;decision_function&#34;</span>)
<span style="color:#75715e"># Try a lower threshold to capture all in-heats and enhance recall rate</span>
threshold <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>
y_pred_t <span style="color:#f92672">=</span> (y_scores <span style="color:#f92672">&gt;</span> threshold)
precision_score(y_train, y_pred_t)
recall_score(y_train, y_pred_t)
confusion_matrix(y_train, y_pred_t)
</code></pre></div><p>The table below shows results of pushing recall to at least 80%. The table also shows the false positive rates which grew in magnitude as recalls were pushed up. FPR&rsquo;s were not too bad in our case as the table below shows!</p>
<p><img src="https://gamalazim.github.io/gamal_portfolio/images/table_thresh_80pct_.png" alt="Confusion Matrix table thresh = 80%"></p>
<p>Finally, let&rsquo;s plot the ROC curve for each of the situations studied in order to evaluate the performance of SGD against this of RF.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-Python" data-lang="Python"><span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> precision_recall_curve
precisions, recalls, thresholds <span style="color:#f92672">=</span> precision_recall_curve(y_train, y_scores)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">plot_precision_recall_vs_threshold</span>(precisions, recalls, thresholds):
    plt<span style="color:#f92672">.</span>plot(thresholds, precisions[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;b--&#34;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Precision&#34;</span>, linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
    plt<span style="color:#f92672">.</span>plot(thresholds, recalls[:<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>], <span style="color:#e6db74">&#34;g-&#34;</span>, label<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;Recall&#34;</span>, linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>)
    plt<span style="color:#f92672">.</span>legend(loc<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;center right&#34;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>)
    plt<span style="color:#f92672">.</span>xlabel(<span style="color:#e6db74">&#34;Threshold&#34;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>)        
    plt<span style="color:#f92672">.</span>grid(True)                              
    plt<span style="color:#f92672">.</span>axis([<span style="color:#f92672">-</span><span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>])             

pt <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.8</span>  <span style="color:#75715e"># Desired recall threshold of 80%</span>

precision_80_recall <span style="color:#f92672">=</span> precisions[np<span style="color:#f92672">.</span>argmax(recalls <span style="color:#f92672">&lt;=</span> pt)]                                     
threshold_80_recall <span style="color:#f92672">=</span> thresholds[np<span style="color:#f92672">.</span>argmax(recalls <span style="color:#f92672">&lt;=</span> pt)]                                  

plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">8</span>, <span style="color:#ae81ff">4</span>))                                                                    
plot_precision_recall_vs_threshold(precisions, recalls, thresholds)
plt<span style="color:#f92672">.</span>plot([threshold_80_recall, threshold_80_recall], [<span style="color:#ae81ff">0.</span>, pt], <span style="color:#e6db74">&#34;r:&#34;</span>)                         
plt<span style="color:#f92672">.</span>plot([<span style="color:#f92672">-</span><span style="color:#ae81ff">10</span>, threshold_80_recall], [pt, pt], <span style="color:#e6db74">&#34;r:&#34;</span>)     <span style="color:#75715e"># My addition</span>
plt<span style="color:#f92672">.</span>plot([threshold_80_recall], [pt], <span style="color:#e6db74">&#34;ro&#34;</span>)                                               
plt<span style="color:#f92672">.</span>plot([threshold_80_recall], [precision_80_recall], <span style="color:#e6db74">&#34;ro&#34;</span>)                                  
save_fig(<span style="color:#e6db74">&#34;precision_recall_vs_threshold_plot&#34;</span>)                                                
plt<span style="color:#f92672">.</span>show()
</code></pre></div><p>Graph panel below shows the recall vs. precision tradeoffs in row 1. Recall values pushed to 80% vs. corresponding precisions were shown. Note that with including trend features in prediction and aligning labels, both precision and recall were already above 80%.</p>
<p>In the second row of the panel, improvement in precision at a fixed 80% recall was highly pronounced which demonstrated the importance of including trend attributes and adjusting labels in training data.</p>
<p>Finally, ROC curves for both SGD and RF were shown in the last row of the panel. Random forest classifier was superior to SGD, particularly with ambiguous data. With cleaner data and more features added, SGD wasn&rsquo;t too bad. The table below the panel shows AUC for each ROC!</p>
<p><img src="https://gamalazim.github.io/gamal_portfolio/images/data_model_selection_.png" alt="ROC Curves"></p>
<p><img src="https://gamalazim.github.io/gamal_portfolio/images/table_roc_auc_.png" alt="ROC Curves"></p>
<h2 id="final-comments-and-conclusions">Final Comments and Conclusions</h2>
<p>In this project I emphasized feature engineering of sensory data to improve recall and precision of heat detection in cattle. The project devised new attributes and adjusted labels which improved the performance of the models trained. Trend parameters across 7 past days building toward ovulation were estimated using fast <strong>R</strong> functions and implemented in <strong>sklearn</strong> classifiers to accurately detect cows that are in-heat. Two cases (In-Heat and BRED) were the target positive labels to predict. Aligning &lsquo;BRED&rsquo; with &lsquo;In-Heat&rsquo; cases by moving them one day earlier enhanced model performance significantly. As explained, &lsquo;BRED&rsquo; events take place on the farm after animals become In-Heat which explains the improvement in model performance observed in this project.</p>
<ul class="pa0">
  
</ul>
<div class="mt6 instapaper_ignoref">
      
      
      </div>
    </div>

    <aside class="w-30-l mt6-l">




</aside>

  </article>

    </main>
    <footer class="bg-black bottom-0 w-100 pa3" role="contentinfo">
  <div class="flex justify-between">
  <a class="f4 fw4 hover-white no-underline white-70 dn dib-ns pv2 ph3" href="https://gamalazim.github.io/gamal_portfolio/" >
    &copy;  Gamal Abdel-Azim 2020 
  </a>
    <div>




<a href="https://twitter.com/abdel_azim" target="_blank" class="link-transition twitter link dib z-999 pt3 pt0-l mr1" title="Twitter link" rel="noopener" aria-label="follow on Twitter——Opens in a new window">
  <svg height="32px"  style="enable-background:new 0 0 67 67;" version="1.1" viewBox="0 0 67 67" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><path d="M37.167,22.283c-2.619,0.953-4.274,3.411-4.086,6.101  l0.063,1.038l-1.048-0.127c-3.813-0.487-7.145-2.139-9.974-4.915l-1.383-1.377l-0.356,1.017c-0.754,2.267-0.272,4.661,1.299,6.271  c0.838,0.89,0.649,1.017-0.796,0.487c-0.503-0.169-0.943-0.296-0.985-0.233c-0.146,0.149,0.356,2.076,0.754,2.839  c0.545,1.06,1.655,2.097,2.871,2.712l1.027,0.487l-1.215,0.021c-1.173,0-1.215,0.021-1.089,0.467  c0.419,1.377,2.074,2.839,3.918,3.475l1.299,0.444l-1.131,0.678c-1.676,0.976-3.646,1.526-5.616,1.568  C19.775,43.256,19,43.341,19,43.405c0,0.211,2.557,1.397,4.044,1.864c4.463,1.377,9.765,0.783,13.746-1.568  c2.829-1.673,5.657-5,6.978-8.221c0.713-1.716,1.425-4.851,1.425-6.354c0-0.975,0.063-1.102,1.236-2.267  c0.692-0.678,1.341-1.419,1.467-1.631c0.21-0.403,0.188-0.403-0.88-0.043c-1.781,0.636-2.033,0.551-1.152-0.402  c0.649-0.678,1.425-1.907,1.425-2.267c0-0.063-0.314,0.042-0.671,0.233c-0.377,0.212-1.215,0.53-1.844,0.72l-1.131,0.361l-1.027-0.7  c-0.566-0.381-1.361-0.805-1.781-0.932C39.766,21.902,38.131,21.944,37.167,22.283z M33,64C16.432,64,3,50.569,3,34S16.432,4,33,4  s30,13.431,30,30S49.568,64,33,64z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/></svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>




<a href="https://www.linkedin.com/in/gamal-abdel-azim-986a40122/" target="_blank" class="link-transition linkedin link dib z-999 pt3 pt0-l mr1" title="LinkedIn link" rel="noopener" aria-label="follow on LinkedIn——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 65 65;" version="1.1" viewBox="0 0 65 65" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
  <path d="M50.837,48.137V36.425c0-6.275-3.35-9.195-7.816-9.195  c-3.604,0-5.219,1.983-6.119,3.374V27.71h-6.79c0.09,1.917,0,20.427,0,20.427h6.79V36.729c0-0.609,0.044-1.219,0.224-1.655  c0.49-1.22,1.607-2.483,3.482-2.483c2.458,0,3.44,1.873,3.44,4.618v10.929H50.837z M22.959,24.922c2.367,0,3.842-1.57,3.842-3.531  c-0.044-2.003-1.475-3.528-3.797-3.528s-3.841,1.524-3.841,3.528c0,1.961,1.474,3.531,3.753,3.531H22.959z M34,64  C17.432,64,4,50.568,4,34C4,17.431,17.432,4,34,4s30,13.431,30,30C64,50.568,50.568,64,34,64z M26.354,48.137V27.71h-6.789v20.427  H26.354z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>


<a href="https://github.com/gamalazim" target="_blank" class="link-transition github link dib z-999 pt3 pt0-l mr1" title="Github link" rel="noopener" aria-label="follow on Github——Opens in a new window">
  <svg  height="32px"  style="enable-background:new 0 0 512 512;" version="1.1" viewBox="0 0 512 512" width="32px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
  <path d="M256,32C132.3,32,32,134.8,32,261.7c0,101.5,64.2,187.5,153.2,217.9c11.2,2.1,15.3-5,15.3-11.1   c0-5.5-0.2-19.9-0.3-39.1c-62.3,13.9-75.5-30.8-75.5-30.8c-10.2-26.5-24.9-33.6-24.9-33.6c-20.3-14.3,1.5-14,1.5-14   c22.5,1.6,34.3,23.7,34.3,23.7c20,35.1,52.4,25,65.2,19.1c2-14.8,7.8-25,14.2-30.7c-49.7-5.8-102-25.5-102-113.5   c0-25.1,8.7-45.6,23-61.6c-2.3-5.8-10-29.2,2.2-60.8c0,0,18.8-6.2,61.6,23.5c17.9-5.1,37-7.6,56.1-7.7c19,0.1,38.2,2.6,56.1,7.7   c42.8-29.7,61.5-23.5,61.5-23.5c12.2,31.6,4.5,55,2.2,60.8c14.3,16.1,23,36.6,23,61.6c0,88.2-52.4,107.6-102.3,113.3   c8,7.1,15.2,21.1,15.2,42.5c0,30.7-0.3,55.5-0.3,63c0,6.1,4,13.3,15.4,11C415.9,449.1,480,363.1,480,261.7   C480,134.8,379.7,32,256,32z"/>
</svg>

<span class="new-window"><svg  height="8px"  style="enable-background:new 0 0 1000 1000;" version="1.1" viewBox="0 0 1000 1000" width="8px" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" >
<path d="M598 128h298v298h-86v-152l-418 418-60-60 418-418h-152v-86zM810 810v-298h86v298c0 46-40 86-86 86h-596c-48 0-86-40-86-86v-596c0-46 38-86 86-86h298v86h-298v596h596z" style="fill-rule:evenodd;clip-rule:evenodd;fill:;"/>
</svg>
</span></a>







</div>
  </div>
</footer>

    

  <script src="https://gamalazim.github.io/gamal_portfolio/dist/js/app.3fc0f988d21662902933.js"></script>


  </body>
</html>
